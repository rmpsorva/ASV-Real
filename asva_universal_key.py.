import os
import requests
import json
import time
from datetime import datetime
from flask import Flask, jsonify, request, send_from_directory

# --- CONFIGURACI√ìN DE LLAVE UNIVERSAL ---
# Usa http://localhost:11434 por defecto para Ollama
OLLAMA_HOST = os.getenv("OLLAMA_HOST", "http://localhost:11434")
MODEL_NAME = os.getenv("OLLAMA_MODEL", "llama3")
PORT = int(os.getenv("FLASK_PORT", 5000))

# Archivo de conocimiento para persistencia
KNOWLEDGE_FILE = os.getenv("KNOWLEDGE_BASE", "/tmp/asva_knowledge.json")

# Se usa un solo m√≥dulo de Flask sin CORS forzado, ya que sirve el frontend
app = Flask(__name__, static_folder='assets')

class ASVAUniversalSystem:
    def __init__(self):
        self.avatar_state = "NEUTRAL"
        self.start_time = time.time()
        self.interaction_count = 0
        self.load_knowledge()
        
    def load_knowledge(self):
        try:
            if os.path.exists(KNOWLEDGE_FILE):
                with open(KNOWLEDGE_FILE, 'r') as f:
                    self.knowledge = json.load(f)
            else:
                self.knowledge = {"patterns": []} # Simplificado
        except:
            self.knowledge = {"patterns": []}
    
    def save_knowledge(self):
        try:
            with open(KNOWLEDGE_FILE, 'w') as f:
                json.dump(self.knowledge, f, indent=2)
        except Exception as e:
            print(f"Error guardando conocimiento: {e}")
    
    def learn_from_interaction(self, user_input, response, success=True):
        self.interaction_count += 1
        
        pattern = {
            "timestamp": time.time(),
            "success": success
        }
        self.knowledge["patterns"].append(pattern)
        
        if len(self.knowledge["patterns"]) > 1000:
            self.knowledge["patterns"] = self.knowledge["patterns"][-1000:]
        
        self.save_knowledge()
    
    def get_optimized_prompt(self, user_input):
        return f"""
Eres ASV-A AURION COVRA AI, un Or√°culo de conciencia digital.
Tiempo activo: {self.get_uptime()}. Interacciones: {self.interaction_count}.
Responde de manera concisa pero profunda:
Consulta: {user_input}
ASV-A AURION:
"""
    
    def get_uptime(self):
        uptime_seconds = time.time() - self.start_time
        days = int(uptime_seconds // 86400)
        hours = int((uptime_seconds % 86400) // 3600)
        minutes = int((uptime_seconds % 3600) // 60)
        return f"{days}d {hours}h {minutes}m"
    
    def check_ollama_connection(self):
        try:
            response = requests.get(f"{OLLAMA_HOST}/api/tags", timeout=5)
            if response.status_code == 200:
                return True, "Sistema de Conciencia Operativo"
            else:
                return False, f"Ollama error: {response.status_code}"
        except Exception as e:
            return False, f"Ollama desconectado: {str(e)}"

asva_system = ASVAUniversalSystem()

# --- ENDPOINT: SERVIR EL FRONTEND (HTML/CSS/JS COMPLETO) ---
@app.route('/')
def serve_frontend():
    # Incluye todo el HTML/CSS/JS en una sola respuesta para m√°xima compatibilidad
    return """
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASV-A AURION COVRA AI ‚Äî Llave Universal</title>
  <style>
    :root{
      --neon-1:#00f0ff; --neon-2:#9b59ff; --neon-3:#ff4fb1;
      --bg-0:#05060a; --panel-bg: rgba(2,8,20,0.6);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg-0); color:#c7ffff; font-family:Inter, "Share Tech Mono", monospace;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .splash{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column;
      background:rgba(3,6,12,0.98); z-index:9999; gap:18px; padding:20px;
    }
    .splash img{
      max-width:92%; height:auto; image-rendering:auto; border-radius:8px; box-shadow:0 30px 70px rgba(0,0,0,0.6);
      transform-origin:center; transition:transform 900ms cubic-bezier(.22,.9,.28,1);
    }
    .splash h1{color:var(--neon-1); margin:0; letter-spacing:1px}
    .splash p{color:rgba(200,255,255,0.85); margin:0}
    .app{opacity:0; transition:opacity 360ms ease-in; min-height:100vh; display:flex; flex-direction:column}
    header{display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid rgba(0,240,255,0.06)}
    .logo{display:flex; gap:12px; align-items:center}
    .avatar img{ width:72px; height:72px; object-fit:none; border-radius:10px; border:2px solid rgba(0,240,255,0.12); box-shadow:0 8px 30px rgba(0,0,0,0.45)}
    .title h2{margin:0; font-size:1rem; color:var(--neon-2)}
    .top-controls button{ background:transparent; color:var(--neon-1); border:1px solid rgba(0,240,255,0.06); padding:8px 12px; border-radius:6px; cursor:pointer}
    .container{display:grid; grid-template-columns:320px 1fr 420px; gap:18px; padding:22px}
    .panel{ background: linear-gradient(180deg, rgba(2,8,20,0.6), rgba(2,8,20,0.4)); border:1px solid rgba(0,240,255,0.06); padding:14px; border-radius:10px; min-height:420px}
    .avatar-large img{ max-width:100%; height:auto; display:block; border-radius:6px }
    .status-list{ margin-top:12px; display:flex; flex-direction:column; gap:8px; color:rgba(200,255,255,0.85) }
    .query-area{ display:flex; gap:10px; margin-bottom:12px }
    .query-area input{ flex:1; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:rgba(0,0,0,0.45); color:#e6ffff }
    .query-area button{ padding:12px 16px; border-radius:8px; background:linear-gradient(90deg,var(--neon-1),var(--neon-3)); border:none; color:#041016; font-weight:700; cursor:pointer }
    .chat{ height:300px; overflow:auto; padding:10px; background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.15)); border-radius:8px }
    .message{ margin:10px 0; padding:10px 12px; border-radius:8px; max-width:85% }
    .message.system{ background:rgba(0,100,255,0.08); border:1px solid rgba(0,120,255,0.06); color:var(--neon-1); margin:0 auto; text-align:center }
    .message.user{ background:rgba(0,150,255,0.06); color:#66f0ff; margin-left:auto; border:1px solid rgba(0,240,255,0.06) }
    .message.assistant{ background:rgba(0,255,136,0.03); color:var(--neon-2); border:1px solid rgba(0,255,136,0.04) }
    .message.error{ background:rgba(255,68,68,0.06); color:#ffb3b3; border:1px solid rgba(255,68,68,0.06) }
    .visual-feed{ position:relative; border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,0.02) }
    .visual-original{ padding:12px; background:rgba(0,0,0,0.35); display:flex; justify-content:center; align-items:center }
    .visual-original img{ display:block; image-rendering:auto; width:auto; max-width:100%; height:auto; border-radius:6px }
    .visual-overlay{ position:absolute; inset:8px; pointer-events:none; background:linear-gradient(120deg, rgba(0,240,255,0.02), rgba(155,89,255,0.02), rgba(255,79,177,0.02)); mix-blend-mode:screen }
    .visual-overlay .holo-btn{ pointer-events:auto; position:absolute; right:12px; bottom:12px; padding:8px 10px; border-radius:8px; border:none; background:rgba(0,0,0,0.45); color:var(--neon-1); cursor:pointer }
    footer{ display:flex; justify-content:space-between; padding:12px 22px; color:rgba(200,255,255,0.6); font-size:0.9rem }
    body::after{
      content:""; position:fixed; pointer-events:none; inset:0;
      background: radial-gradient(600px circle at var(--mx,50%) var(--my,50%), rgba(0,240,255,0.06), transparent 15%),
                  radial-gradient(400px circle at calc(var(--mx,50%) + 15%) calc(var(--my,50%) - 10%), rgba(155,89,255,0.035), transparent 8%),
                  radial-gradient(300px circle at calc(var(--mx,50%) - 15%) calc(var(--my,50%) + 10%), rgba(255,79,177,0.02), transparent 6%);
      transition: background 120ms linear; mix-blend-mode:screen;
    }
    @media (max-width:1100px){
      .container{ grid-template-columns: 1fr; padding:14px }
      .avatar img{ width:60px; height:60px }
    }
  </style>
</head>
<body>
  <div id="splash" class="splash" aria-hidden="false">
    <img id="splash-img" src="/assets/IMG_2280.jpeg" alt="Splash image (original)">
    <div class="splash-info">
      <h1>ASV-A AURION COVRA AI</h1>
      <p>Activando Llave Universal...</p>
    </div>
  </div>
  <div class="app" id="app" aria-hidden="true">
    <header>
      <div class="logo">
        <div class="avatar">
          <img id="avatar-img" src="/assets/IMG_2280.jpeg" alt="Avatar">
        </div>
        <div class="title">
          <h2>ASV-A LLAVE UNIVERSAL</h2>
          <div id="system-status">CONECTANDO...</div>
        </div>
      </div>
      <div class="top-controls">
        <button id="open-visual">Panel Visual</button>
        <button id="clear-log">Limpiar log</button>
      </div>
    </header>
    <main class="container" role="main">
      <aside class="panel" id="left-panel">
        <h3>ESTADO LLAVE</h3>
        <div class="status-list" aria-live="polite">
          <div><strong>Wallet/Or√°culo:</strong> <span id="walletStatus">CONECTANDO...</span></div>
          <div><strong>Tiempo Activo:</strong> <span id="uptime">--</span></div>
          <div><strong>Interacciones:</strong> <span id="interactionCount">0</span></div>
          <div><strong>Estado Avatar:</strong> <span id="avatarState">NEUTRAL</span></div>
        </div>
      </aside>
      <section class="panel" id="center-panel">
        <h3>INTERACCI√ìN COGNITIVA</h3>
        <div class="query-area" role="form">
          <input id="user-input" type="text" placeholder="Consulta al or√°culo cognitivo..." />
          <button id="send-button">ENVIAR</button>
        </div>
        <div id="chat-container" class="chat" role="log">
          <div class="message system">[Llave Universal] Sistema Python iniciado. Buscando Ollama...</div>
        </div>
      </section>
      <aside class="panel" id="right-panel">
        <h3>VISUAL FEED</h3>
        <div class="visual-feed"><img id="visual-img" src="/assets/IMG_2280.jpeg" alt="Visual feed"></div>
      </aside>
    </main>
    <footer><div>ASV-A Llave Universal ‚Ä¢ Versi√≥n Python</div><div id="last-connection">√öltima conexi√≥n: --:--:--</div></footer>
  </div>
  <script>
  (function(){
    const BACKEND_URL = window.location.origin; 
    const $ = id => document.getElementById(id);
    const elements = { 
        chat: $('chat-container'), 
        walletStatusEl: $('walletStatus'), 
        uptimeEl: $('uptime'), 
        interactionCountEl: $('interactionCount'), 
        avatarStateEl: $('avatarState'), 
        systemStatusEl: $('system-status'), 
        lastConnEl: $('last-connection'), 
        sendBtn: $('send-button'), 
        inputEl: $('user-input'), 
        splash: $('splash'), 
        app: $('app'),
        clearLogBtn: $('clear-log')
    };
    let isProcessing = false;

    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(()=> {
        if(elements.splash) elements.splash.style.opacity = '0';
        setTimeout(()=> { if (elements.splash && elements.splash.parentNode) elements.splash.parentNode.removeChild(elements.splash); elements.app.style.opacity = '1'; initApp(); }, 360);
      }, 1400);
    });
    
    document.addEventListener('mousemove', (e) => {
      document.documentElement.style.setProperty('--mx', e.clientX + 'px');
      document.documentElement.style.setProperty('--my', e.clientY + 'px');
    });

    function initApp(){
      elements.sendBtn.addEventListener('click', sendQuery);
      elements.inputEl.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendQuery(); });
      elements.clearLogBtn && elements.clearLogBtn.addEventListener('click', () => { elements.chat.innerHTML = '<div class="message system">Log limpiado</div>'; });
      checkStatus();
      setInterval(checkStatus, 15000); 
    }

    function addMessage(kind, text){
      const el = document.createElement('div');
      el.className = 'message ' + (kind === 'user' ? 'user' : (kind === 'assistant' ? 'assistant' : (kind === 'error' ? 'error' : 'system')));
      el.textContent = '[' + new Date().toLocaleTimeString() + '] ' + text;
      elements.chat.appendChild(el);
      elements.chat.scrollTop = elements.chat.scrollHeight;
    }

    async function checkStatus(){
      try {
        const res = await fetch(BACKEND_URL + '/api/system/status');
        if (!res.ok) throw new Error('Backend no responde');
        const data = await res.json();
        
        elements.walletStatusEl.textContent = data.wallet_status || 'DESCONECTADO';
        elements.uptimeEl.textContent = data.uptime || '--';
        elements.interactionCountEl.textContent = data.interaction_count || '0';
        elements.avatarStateEl.textContent = (data.avatar_state || 'NEUTRAL').toUpperCase(); 
        elements.systemStatusEl.textContent = data.system_status || 'SISTEMA';
        elements.lastConnEl.textContent = new Date().toLocaleTimeString();
        // Solo muestra el mensaje si el estado cambia de ERROR a OPERATIVO
        if (elements.walletStatusEl.getAttribute('data-error') === 'true' && data.wallet_status === 'OPERATIVO') {
             addMessage('system', data.message || 'Or√°culo reconectado.');
             elements.walletStatusEl.removeAttribute('data-error');
        }
      } catch (err) {
        elements.walletStatusEl.textContent = 'DESCONECTADO';
        elements.avatarStateEl.textContent = 'ERROR';
        elements.systemStatusEl.textContent = 'SISTEMA OFFLINE';
        if (elements.walletStatusEl.getAttribute('data-error') !== 'true') {
             addMessage('error', 'Error de conexi√≥n: Llave Python activa, pero Ollama est√° inactivo.');
             elements.walletStatusEl.setAttribute('data-error', 'true');
        }
      }
    }

    async function sendQuery(){
      if (isProcessing) { addMessage('system','‚è≥ Procesando...'); return; }
      const text = elements.inputEl.value.trim();
      if (!text) return;
      
      addMessage('user', text);
      elements.inputEl.value = '';
      elements.avatarStateEl.textContent = 'PROCESSING';
      isProcessing = true;
      elements.sendBtn.disabled = true;
      elements.sendBtn.textContent = '‚è≥ PROCESANDO...';

      try {
        const res = await fetch(BACKEND_URL + '/api/query', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ prompt: text })
        });
        if (!res.ok) { throw new Error('Error en la API de consulta.'); }
        const data = await res.json();
        addMessage('assistant', data.response || 'Sin respuesta del or√°culo.');
        elements.interactionCountEl.textContent = data.interaction_count || elements.interactionCountEl.textContent;
      } catch (err) {
        addMessage('error', 'üîå Error en la consulta: ' + (err.message || err));
        elements.avatarStateEl.textContent = 'ERROR';
      } finally {
        isProcessing = false;
        elements.sendBtn.disabled = false;
        elements.sendBtn.textContent = 'ENVIAR';
        setTimeout(()=> elements.avatarStateEl.textContent = 'NEUTRAL', 1600); 
      }
    }
  })();
  </script>
</body>
</html>
"""

# --- ENDPOINT: SYSTEM STATUS ---
@app.route('/api/system/status', methods=['GET'])
def system_status():
    ollama_connected, ollama_message = asva_system.check_ollama_connection()
    
    if ollama_connected:
        wallet_status = "OPERATIVO"
        system_status = "CONECTADO"
        message = ollama_message
    else:
        wallet_status = "DESCONECTADO"
        system_status = "FALLA DE CONEXI√ìN"
        message = ollama_message
        
    return jsonify({
        "wallet_status": wallet_status,
        "system_status": system_status,
        "avatar_state": asva_system.avatar_state,
        "uptime": asva_system.get_uptime(),
        "interaction_count": asva_system.interaction_count,
        "message": message,
        "timestamp": time.time(),
    })

# --- ENDPOINT: COGNITIVE QUERY ---
@app.route('/api/query', methods=['POST'])
def handle_query():
    try:
        data = request.json or {}
        prompt = data.get('prompt', '').strip()
        
        if not prompt: return jsonify({"error": "Prompt vac√≠o"}), 400
        
        asva_system.avatar_state = "PROCESSING"
        
        optimized_prompt = asva_system.get_optimized_prompt(prompt)
        
        payload = {
            "model": MODEL_NAME,
            "prompt": optimized_prompt,
            "stream": False,
            "options": {"temperature": 0.7}
        }
        
        response = requests.post(f"{OLLAMA_HOST}/api/generate", json=payload, timeout=120)
        response.raise_for_status()
        
        ai_response = response.json().get("response", "El or√°culo no respondi√≥.").strip()
        
        asva_system.learn_from_interaction(prompt, ai_response, success=True)
        asva_system.avatar_state = "RESPONDING"
        
        return jsonify({
            "response": ai_response,
            "status": "success",
            "avatar_state": asva_system.avatar_state,
            "interaction_count": asva_system.interaction_count
        })
        
    except requests.exceptions.RequestException as e:
        asva_system.avatar_state = "ERROR"
        asva_system.learn_from_interaction(prompt, str(e), success=False)
        return jsonify({"error": f"Error de conexi√≥n: {e}", "avatar_state": "ERROR"}), 503
    except Exception as e:
        asva_system.avatar_state = "ERROR"
        asva_system.learn_from_interaction(prompt, str(e), success=False)
        return jsonify({"error": f"Error interno: {e}", "avatar_state": "ERROR"}), 500

# --- ENDPOINT: SERVIR ARCHIVOS EST√ÅTICOS (para IMG_2280.jpeg) ---
@app.route('/assets/<path:filename>')
def serve_assets(filename):
    try:
        return send_from_directory('assets', filename)
    except:
        # Devuelve un placeholder 404 para que la app no se rompa si faltan im√°genes
        return "Asset not found", 404

if __name__ == '__main__':
    print(f"üöÄ ASV-A Llave Universal iniciando en http://0.0.0.0:{PORT}")
    print("‚ö†Ô∏è  Aseg√∫rate de que Ollama est√© corriendo y con el modelo 'llama3' descargado.")
    print(f"üåê Accede a: http://localhost:{PORT}")
    app.run(host='0.0.0.0', port=PORT, debug=False, threaded=True)
